# Docker Compose Development Override
# Usage: docker compose -f docker-compose.yml -f docker-compose.dev.yml up
# Or simply: make aegis-dev

services:
  postgres:
    # Expose PostgreSQL port for local tools (psql, pgAdmin, etc.)
    ports:
      - "${POSTGRES_PORT:-5432}:5432"

  minio:
    # Faster healthcheck in dev
    healthcheck:
      test: ["CMD", "mc", "ready", "local"]
      interval: 5s
      timeout: 2s
      retries: 3

  backend:
    command: >
      uvicorn main:app
      --host 0.0.0.0
      --port 8888
      --reload
      --reload-dir /app/api
      --reload-dir /app/services
      --reload-dir /app/models
      --reload-dir /app/database

    # Override depends_on to not require healthcheck in dev
    depends_on:
      postgres:
        condition: service_started
      minio:
        condition: service_started
      garak:
        condition: service_started

    environment:
      LOG_LEVEL: DEBUG
      PYTHONDONTWRITEBYTECODE: "1"
      PYTHONUNBUFFERED: "1"
      DATABASE_URL: "postgresql://${POSTGRES_USER:-aegis}:${POSTGRES_PASSWORD:-aegis-secret}@postgres:5432/${POSTGRES_DB:-aegis}"
      STORAGE_BACKEND: "${STORAGE_BACKEND:-minio}"
      MINIO_ENDPOINT: "minio:9000"
      MINIO_ACCESS_KEY: "${MINIO_ROOT_USER:-aegis}"
      MINIO_SECRET_KEY: "${MINIO_ROOT_PASSWORD:-aegis-secret}"
      MINIO_BUCKET: "${MINIO_BUCKET:-aegis-reports}"
      MINIO_SECURE: "false"
      GARAK_REPORTS_DIR: "/tmp/garak_reports"
      GARAK_SERVICE_URL: "http://garak:9090"
      OLLAMA_HOST: "http://host.docker.internal:11434"

    extra_hosts:
      - "host.docker.internal:host-gateway"

    volumes:
      # Mount source code for hot reload
      - ./api:/app/api:cached
      - ./services:/app/services:cached
      - ./models:/app/models:cached
      - ./database:/app/database:cached
      - ./config.py:/app/config.py:cached
      - ./main.py:/app/main.py:cached
      # Mount tests for `make test`
      - ./tests:/app/tests:cached

    healthcheck:
      disable: true

  garak:
    command: >
      uvicorn app:app
      --host 0.0.0.0
      --port 9090
      --reload

    environment:
      LOG_LEVEL: DEBUG
      OLLAMA_HOST: "http://host.docker.internal:11434"

    extra_hosts:
      - "host.docker.internal:host-gateway"

    volumes:
      # Mount garak service code for hot reload
      - ./services/garak_service:/app:cached
      # Bind mount for garak reports scratch (dev inspection only)
      - "${GARAK_REPORTS_HOST_DIR:-./garak_reports}:/data/garak_reports"

    # Disable slow healthcheck in dev for faster startup
    healthcheck:
      test: ["CMD", "true"]
      interval: 5s
      timeout: 2s
      retries: 1
      start_period: 1s
