# Docker Compose Development Override
# Usage: docker compose -f docker-compose.yml -f docker-compose.dev.yml up
# Or simply: make aegis-dev

version: '3.8'

services:
  backend:
    command: >
      uvicorn main:app
      --host 0.0.0.0
      --port 8888
      --reload
      --reload-dir /app/api
      --reload-dir /app/services
      --reload-dir /app/models

    # Override depends_on to not require healthcheck in dev
    depends_on:
      garak:
        condition: service_started

    environment:
      LOG_LEVEL: DEBUG
      PYTHONDONTWRITEBYTECODE: "1"
      PYTHONUNBUFFERED: "1"
      GARAK_REPORTS_DIR: "/data/garak_reports"
      GARAK_SERVICE_URL: "http://garak:9090"
      OLLAMA_HOST: "http://host.docker.internal:11434"

    extra_hosts:
      - "host.docker.internal:host-gateway"

    volumes:
      # Mount source code for hot reload
      - ./api:/app/api:cached
      - ./services:/app/services:cached
      - ./models:/app/models:cached
      - ./config.py:/app/config.py:cached
      - ./main.py:/app/main.py:cached
      # Bind mount for reports in dev (easier to inspect)
      - "${GARAK_REPORTS_HOST_DIR:-./garak_reports}:/data/garak_reports"

    healthcheck:
      disable: true

  garak:
    command: >
      uvicorn app:app
      --host 0.0.0.0
      --port 9090
      --reload

    environment:
      LOG_LEVEL: DEBUG
      OLLAMA_HOST: "http://host.docker.internal:11434"

    extra_hosts:
      - "host.docker.internal:host-gateway"

    volumes:
      # Mount garak service code for hot reload
      - ./services/garak_service:/app:cached
      # Bind mount for reports in dev
      - "${GARAK_REPORTS_HOST_DIR:-./garak_reports}:/data/garak_reports"

    # Disable slow healthcheck in dev for faster startup
    healthcheck:
      test: ["CMD", "true"]
      interval: 5s
      timeout: 2s
      retries: 1
      start_period: 1s
